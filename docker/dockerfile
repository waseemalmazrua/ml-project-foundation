# =========================================================
# 1๏ธโฃ ูุญุฏุฏ ุตูุฑุฉ ุงูุฃุณุงุณ (Base Image)
# =========================================================
# ูุณุชุฎุฏู Python 3.10 slim:
# - slim = ุญุฌู ุตุบูุฑ
# - ููุงุณุจ ูุชุทุจููุงุช ML APIs
# - ุฃูู surface ูููุฌูุงุช
FROM python:3.10-slim


# =========================================================
# 2๏ธโฃ ุฅุนุฏุงุฏ ูุชุบูุฑุงุช ุจูุฆุฉ ููููุฉ ููุฅูุชุงุฌ
# =========================================================

# ูููุน Python ูู ุฅูุดุงุก ูููุงุช .pyc
# ูุฐุง ูููู clutter ุฏุงุฎู ุงููููุชููุฑ
ENV PYTHONDONTWRITEBYTECODE=1

# ูุฌุนู stdout / stderr ุบูุฑ ูุคูุช (unbuffered)
# ููู ุฌุฏูุง ุนุดุงู logs ุชุธูุฑ ูุจุงุดุฑุฉ (Docker / Kubernetes)
ENV PYTHONUNBUFFERED=1


# =========================================================
# 3๏ธโฃ ุชุญุฏูุฏ ูุฌูุฏ ุงูุนูู ุฏุงุฎู ุงููููุชููุฑ
# =========================================================
# ุฃู ุฃูุฑ ุจุนุฏ ูุฐุง ุงูุณุทุฑ ุณูููููุฐ ุฏุงุฎู /app
# ูุฐุง ูู root ุงููุดุฑูุน ุฏุงุฎู ุงููููุชููุฑ
WORKDIR /app


# =========================================================
# 4๏ธโฃ ุชุซุจูุช uv (ูุฏูุฑ ุงูุญุฒู)
# =========================================================
# uv ุบูุฑ ููุฌูุฏ ุงูุชุฑุงุถููุง ูู ุตูุฑุฉ Python
# ูุซุจูุชู ุจุงุณุชุฎุฏุงู pip
# --no-cache-dir ูููู ุญุฌู ุงูุตูุฑุฉ ุงูููุงุฆูุฉ
RUN pip install --no-cache-dir uv


# =========================================================
# 5๏ธโฃ ูุณุฎ ูููุงุช ุงูุงุนุชูุงุฏ ููุท (Optimization Layer)
# =========================================================
# ููุณุฎ pyproject.toml ู uv.lock ููุท
# ุงูุณุจุจ:
# - Docker ูุจูู layers
# - ุทุงููุง ูุฐู ุงููููุงุช ูู ุชุชุบูุฑ โ ูู ูุนูุฏ ุชุซุจูุช ุงูููุชุจุงุช
# - ูุฐุง ูุณุฑูุน build ุจุดูู ูุจูุฑ
COPY pyproject.toml uv.lock ./


# =========================================================
# 6๏ธโฃ ุชุซุจูุช ุงูููุชุจุงุช ุจุงุณุชุฎุฏุงู uv
# =========================================================
# uv sync:
# - ููุฑุฃ uv.lock
# - ูุซุจุช EXACT versions
# --frozen:
# - ูููุน ุฃู ุงุฎุชูุงู
# - ูู ุญุตู mismatch โ ููุดู ุงูุจูุงุก
# ูุฐุง ูุถูู reproducibility 100%
RUN uv sync --frozen


# =========================================================
# 7๏ธโฃ ูุณุฎ ููุฏ ุงููุดุฑูุน
# =========================================================
# ููุณุฎ ููุท ูุง ูุญุชุงุฌู ููุชุดุบูู
# ูุง ููุณุฎ notebooks / data / mlruns (ุฅูุง ูู ุงุญุชุฌุช)
COPY src ./src
COPY scripts ./scripts


# =========================================================
# 8๏ธโฃ ุฅุนุฏุงุฏ PYTHONPATH
# =========================================================
# ูุถูู /app ุฅูู PYTHONPATH
# ูุฐุง ูุณูุญ ุจู imports ูุซู:
# from app.api.main import app
ENV PYTHONPATH=/app/src


# =========================================================
# 9๏ธโฃ ุชูุซูู ุงููููุฐ ุงููุณุชุฎุฏู
# =========================================================
# EXPOSE ูุง ููุชุญ ุงููููุฐ ูุนูููุง
# ูููู ููุซูู ุฃู ุงูุชุทุจูู ูุนูู ุนูู 4028
EXPOSE 4028


# =========================================================
# ๐ ุฃูุฑ ุงูุชุดุบูู (Entry Point)
# =========================================================
# ูุดุบูู uvicorn ูู ASGI server
# ุงูุตูุบุฉ:
# module.path:fastapi_instance
#
# src.app.api.main:app ุชุนูู:
# - src = ูุฌูุฏ
# - app = package
# - api.main = ุงูููู
# - app = FastAPI instance
#
# --host 0.0.0.0:
# ูุณูุญ ุจุงููุตูู ูู ุฎุงุฑุฌ ุงููููุชููุฑ
#
# --port 4028:
# ููุณ ุงููููุฐ ุงูุฐู ูุฑุจุทู ูู docker / compose
CMD ["uv", "run", "uvicorn", "src.app.api.main:app", "--host", "0.0.0.0", "--port", "4028"]
